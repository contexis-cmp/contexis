# RAG System Example

This example demonstrates how to build a Retrieval-Augmented Generation (RAG) system using Contexis with **local models by default**.

## Overview

A RAG system combines:
- **Knowledge Base**: Vector store with your documents
- **Semantic Search**: Find relevant information
- **Text Generation**: Generate responses using local models

## Quick Start

### 1. Initialize Project

```bash
# Create a new project
ctx init rag-example
cd rag-example

# Set up environment
cp .env.example .env
pip install -r requirements.txt
```

### 2. Generate RAG System

```bash
# Generate RAG system with local embeddings
ctx generate rag CustomerDocs --db=sqlite --embeddings=sentence-transformers
```

This creates:
- `contexts/CustomerDocs/` - Agent configuration
- `memory/CustomerDocs/` - Knowledge base structure
- `prompts/CustomerDocs/` - Response templates
- `tools/CustomerDocs/` - Search tools
- `tests/CustomerDocs/` - Test suite

### 3. Add Knowledge

```bash
# Create sample documents
mkdir -p memory/CustomerDocs/documents

# Add company policies
cat > memory/CustomerDocs/documents/policies.txt << 'EOF'
Return Policy: Returns are accepted within 30 days of purchase with original receipt. Items must be in original condition and packaging.

Shipping Policy: We offer free shipping on orders over $50. Standard shipping takes 3-5 business days.

Customer Service Hours: Our customer service team is available Monday-Friday, 9 AM - 6 PM EST.

Privacy Policy: We respect your privacy and never share personal information with third parties.
EOF

# Ingest documents into vector store
ctx memory ingest --provider=sqlite --component=CustomerDocs --input=memory/CustomerDocs/documents/policies.txt
```

### 4. Test Your RAG System

```bash
# Test with local models (no API keys needed!)
ctx run CustomerDocs "What is your return policy?"
ctx run CustomerDocs "How long does shipping take?"
ctx run CustomerDocs "What are your customer service hours?"
```

## Configuration

### Local Development (Default)

The system uses local models by default:

```yaml
# config/environments/development.yaml
providers:
  local:
    model: microsoft/DialoGPT-medium
    temperature: 0.1
    max_tokens: 1000

embeddings:
  provider: sentence-transformers
  model: all-MiniLM-L6-v2

vector_db:
  provider: chroma
  path: ./data/embeddings
```

### Production Migration

When ready for production, switch to external providers:

```yaml
# config/environments/production.yaml
providers:
  openai:
    api_key: ${OPENAI_API_KEY}
    model: gpt-4o-mini

embeddings:
  provider: openai
  model: text-embedding-3-small

vector_db:
  provider: pinecone
  api_key: ${PINECONE_API_KEY}
```

## Advanced Usage

### 1. Add More Documents

```bash
# Add product catalog
cat > memory/CustomerDocs/documents/products.txt << 'EOF'
Product: Wireless Headphones
Price: $99.99
Features: Noise cancellation, 30-hour battery life, Bluetooth 5.0

Product: Smart Watch
Price: $199.99
Features: Heart rate monitor, GPS, Water resistant
EOF

ctx memory ingest --provider=sqlite --component=CustomerDocs --input=memory/CustomerDocs/documents/products.txt
```

### 2. Search Knowledge Base

```bash
# Search for specific information
ctx memory search --provider=sqlite --component=CustomerDocs --query="wireless headphones" --top-k=3
```

### 3. Test Drift Detection

```bash
# Monitor AI behavior consistency
ctx test --drift-detection --component=CustomerDocs
```

### 4. Start Development Server

```bash
# Start server for continuous development
ctx serve --addr :8000

# Test via HTTP API
curl -X POST http://localhost:8000/api/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "context": "CustomerDocs",
    "component": "CustomerDocs",
    "query": "What is your return policy?",
    "top_k": 5
  }'
```

## Customization

### 1. Modify Context

Edit `contexts/CustomerDocs/CustomerDocs.ctx`:

```yaml
name: "Customer Support Agent"
version: "1.0.0"
description: "Handles customer inquiries with company knowledge"

role:
  persona: "Professional, helpful customer service representative"
  capabilities: ["answer_questions", "process_returns", "provide_product_info"]
  limitations: ["no_refunds_over_policy", "no_personal_data_sharing"]

guardrails:
  tone: "professional"
  format: "text"
  max_tokens: 500
  temperature: 0.1
```

### 2. Customize Prompts

Edit `prompts/CustomerDocs/search_response.md`:

```markdown
# Customer Support Response

**Customer Query:** {{ .user_query }}

**Relevant Information:**
{{#each knowledge_results}}
- {{ content }} (relevance: {{ score }})
{{/each}}

**Response:**
Based on our company policies and product information:

{{ .response }}

---
*Response generated by CustomerDocs RAG system*
```

### 3. Add Custom Tools

Create `tools/CustomerDocs/custom_search.py`:

```python
class CustomSearchTool:
    def __init__(self, config):
        self.config = config
    
    async def search(self, query, top_k=5):
        # Custom search logic
        return results
```

## Testing

### 1. Run All Tests

```bash
# Run comprehensive tests
ctx test --all --coverage
```

### 2. Test Specific Scenarios

```bash
# Test drift detection
ctx test --drift-detection --component=CustomerDocs

# Test correctness
ctx test --correctness --rules=./tests/business_rules.yaml
```

### 3. Performance Testing

```bash
# Test response times
time ctx run CustomerDocs "What is your return policy?"

# Monitor resource usage
htop
```

## Troubleshooting

### Common Issues

1. **Model Download Issues**
   ```bash
   # Pre-download models
   ctx models warmup
   
   # Check disk space
   df -h ./data/models
   ```

2. **Memory Issues**
   ```bash
   # Verify embeddings generation
   ctx memory search --provider=sqlite --component=CustomerDocs --query="test" --top-k=1
   ```

3. **Response Quality**
   ```bash
   # Check prompt templates
   cat prompts/CustomerDocs/search_response.md
   
   # Test with different queries
   ctx run CustomerDocs "What are your policies?"
   ```

### Performance Optimization

1. **Model Warmup**
   ```bash
   # Pre-download models for faster startup
   ctx models warmup
   ```

2. **Vector Store Optimization**
   ```bash
   # Optimize vector store
   ctx memory optimize --provider=sqlite --component=CustomerDocs
   ```

## Next Steps

- **Add more documents** to expand knowledge base
- **Customize prompts** for better responses
- **Add business rules** for compliance
- **Set up monitoring** for production deployment
- **Migrate to production** providers when ready

## Resources

- [Getting Started Guide](../docs/guides/getting-started.md)
- [CLI Reference](../docs/cli.md)
- [Model Providers](../docs/model_providers.md)
- [Memory Management](../docs/memory.md) 