# Conversational Agent Example

This example demonstrates how to build a conversational AI agent using Contexis with **local models by default**.

## Overview

A conversational agent provides:
- **Natural Conversations**: Multi-turn dialogue capabilities
- **Context Awareness**: Remembers conversation history
- **Tool Integration**: Can call external APIs and services
- **Personality**: Customizable agent persona and behavior

## Quick Start

### 1. Initialize Project

```bash
# Create a new project
ctx init agent-example
cd agent-example

# Set up environment
cp .env.example .env
pip install -r requirements.txt
```

### 2. Generate Agent

```bash
# Generate conversational agent with local models
ctx generate agent SupportBot --tools web_search,database --memory episodic
```

This creates:
- `contexts/SupportBot/` - Agent configuration
- `memory/SupportBot/` - Conversation memory
- `prompts/SupportBot/` - Response templates
- `tools/SupportBot/` - Tool integrations
- `tests/SupportBot/` - Test suite

### 3. Test Your Agent

```bash
# Test with local models (no API keys needed!)
ctx run SupportBot "Hello, I need help with my order"
ctx run SupportBot "What's the status of order #12345?"
ctx run SupportBot "Can you help me with a return?"
```

## Configuration

### Local Development (Default)

The agent uses local models by default:

```yaml
# config/environments/development.yaml
providers:
  local:
    model: microsoft/DialoGPT-medium
    temperature: 0.1
    max_tokens: 1000

memory:
  provider: episodic
  max_history: 10
  privacy: user_isolated
```

### Production Migration

When ready for production, switch to external providers:

```yaml
# config/environments/production.yaml
providers:
  openai:
    api_key: ${OPENAI_API_KEY}
    model: gpt-4o-mini

memory:
  provider: redis
  url: ${REDIS_URL}
```

## Advanced Usage

### 1. Multi-Turn Conversations

```bash
# Start a conversation
ctx run SupportBot "Hi, I'm having trouble with my account"

# Continue the conversation
ctx run SupportBot "Yes, I forgot my password"

# The agent remembers context from previous messages
ctx run SupportBot "Can you help me reset it?"
```

### 2. Tool Integration

The agent can use tools for external actions:

```bash
# Agent can search the web
ctx run SupportBot "What's the latest news about AI?"

# Agent can query databases
ctx run SupportBot "What's the status of my recent orders?"

# Agent can make API calls
ctx run SupportBot "Can you check the weather in New York?"
```

### 3. Test Agent Behavior

```bash
# Test conversation flow
ctx test --drift-detection --component=SupportBot

# Test specific scenarios
ctx test --correctness --rules=./tests/business_rules.yaml
```

### 4. Start Development Server

```bash
# Start server for continuous development
ctx serve --addr :8000

# Test via HTTP API
curl -X POST http://localhost:8000/api/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "context": "SupportBot",
    "component": "SupportBot",
    "query": "Hello, I need help",
    "data": {"conversation_id": "user123"}
  }'
```

## Customization

### 1. Modify Agent Personality

Edit `contexts/SupportBot/SupportBot.ctx`:

```yaml
name: "Customer Support Agent"
version: "1.0.0"
description: "Helpful customer support agent"

role:
  persona: "Friendly, professional customer service representative who is patient and empathetic"
  capabilities: ["answer_questions", "process_orders", "handle_returns", "escalate_issues"]
  limitations: ["no_refunds_over_policy", "no_personal_data_sharing", "no_financial_advice"]

guardrails:
  tone: "friendly"
  format: "text"
  max_tokens: 500
  temperature: 0.2

memory:
  episodic: true
  max_history: 15
  privacy: user_isolated
```

### 2. Customize Response Templates

Edit `prompts/SupportBot/agent_response.md`:

```markdown
# Support Agent Response

**Conversation Context:**
{{#if conversation_history}}
Previous messages:
{{#each conversation_history}}
- {{ role }}: {{ content }}
{{/each}}
{{/if}}

**Current User Message:** {{ .user_input }}

**Agent Response:**
{{ .response }}

---
*Response generated by SupportBot agent*
```

### 3. Add Custom Tools

Create `tools/SupportBot/order_lookup.py`:

```python
class OrderLookupTool:
    def __init__(self, config):
        self.config = config
    
    async def lookup_order(self, order_id):
        # Connect to order database
        # Return order status
        return {
            "order_id": order_id,
            "status": "shipped",
            "tracking_number": "123456789"
        }
```

### 4. Configure Memory

Edit `memory/SupportBot/memory_config.yaml`:

```yaml
provider: episodic
max_history: 15
privacy: user_isolated
storage:
  type: file
  path: ./data/conversations
```

## Testing

### 1. Run All Tests

```bash
# Run comprehensive tests
ctx test --all --coverage
```

### 2. Test Conversation Flow

```bash
# Test conversation scenarios
ctx test --drift-detection --component=SupportBot

# Test specific conversation paths
ctx test --correctness --rules=./tests/conversation_rules.yaml
```

### 3. Performance Testing

```bash
# Test response times
time ctx run SupportBot "Hello"

# Test memory usage
htop
```

## Conversation Examples

### Customer Support Scenario

```bash
# User: "Hi, I need help with my order"
ctx run SupportBot "Hi, I need help with my order"

# Agent: "Hello! I'd be happy to help you with your order. Could you please provide your order number?"

# User: "My order number is #12345"
ctx run SupportBot "My order number is #12345"

# Agent: "Thank you! Let me look up order #12345 for you. I can see that your order was shipped yesterday and is currently in transit. The estimated delivery date is tomorrow. Is there anything specific about your order that I can help you with?"

# User: "Can I change the delivery address?"
ctx run SupportBot "Can I change the delivery address?"

# Agent: "I understand you'd like to change the delivery address for order #12345. Unfortunately, since your order has already been shipped, I cannot change the delivery address. However, I can help you with a few alternatives..."
```

### Technical Support Scenario

```bash
# User: "I'm having trouble logging into my account"
ctx run SupportBot "I'm having trouble logging into my account"

# Agent: "I'm sorry to hear you're having trouble logging in. Let me help you troubleshoot this. First, could you tell me what happens when you try to log in? Do you get an error message?"

# User: "It says 'invalid password'"
ctx run SupportBot "It says 'invalid password'"

# Agent: "I see you're getting an 'invalid password' error. This is a common issue that we can resolve. Let me help you reset your password. I'll send a password reset link to the email address associated with your account. Would you like me to do that now?"
```

## Troubleshooting

### Common Issues

1. **Conversation Memory Issues**
   ```bash
   # Check memory configuration
   cat memory/SupportBot/memory_config.yaml
   
   # Test memory storage
   ctx memory search --provider=episodic --component=SupportBot --query="test"
   ```

2. **Tool Integration Issues**
   ```bash
   # Check tool configuration
   cat contexts/SupportBot/SupportBot.ctx
   
   # Test tool availability
   ctx context validate SupportBot
   ```

3. **Response Quality Issues**
   ```bash
   # Check prompt templates
   cat prompts/SupportBot/agent_response.md
   
   # Test with different inputs
   ctx run SupportBot "Hello"
   ctx run SupportBot "Help me"
   ```

### Performance Optimization

1. **Memory Management**
   ```bash
   # Optimize conversation memory
   ctx memory optimize --provider=episodic --component=SupportBot
   ```

2. **Model Warmup**
   ```bash
   # Pre-download models for faster responses
   ctx models warmup
   ```

## Next Steps

- **Add more tools** for external integrations
- **Customize personality** for your brand
- **Add conversation flows** for common scenarios
- **Implement authentication** for user management
- **Set up monitoring** for conversation quality
- **Migrate to production** providers when ready

## Resources

- [Getting Started Guide](../docs/guides/getting-started.md)
- [CLI Reference](../docs/cli.md)
- [Model Providers](../docs/model_providers.md)
- [Memory Management](../docs/memory.md)
